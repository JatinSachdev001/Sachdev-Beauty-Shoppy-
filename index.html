<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sachdev Beauty shoppy</title>
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <style>
        /* General Styles */
        :root {
            --primary-color: #ef4444;
            --secondary-color: #f9fafb;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --light-gray: #f4f4f8;
            --dark-text: #1f2937;
            --medium-text: #6b7280;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            margin: 0;
            background-color: var(--light-gray);
        }

        .screen {
            display: none;
            padding-bottom: 70px;
            animation: fadeIn 0.3s;
        }

        .screen.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        /* --- UPDATED HEADER & SEARCH STYLES --- */
        .header-wrapper {
            background-color: var(--primary-color);
            border-bottom-left-radius: 30px;
            border-bottom-right-radius: 30px;
            padding-bottom: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            color: white;
        }

        .header-location {
            display: flex;
            flex-direction: column;
        }

        .header-location span:first-child {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.8);
        }

        .header-location span:last-child {
            font-weight: bold;
            color: white;
        }

        .header-icons {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .header-icons svg {
            width: 24px;
            height: 24px;
        }

        /* Search Bar Section */
        .search-container {
            padding: 5px 15px;
        }

        .search-wrapper {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .search-bar {
            flex-grow: 1;
            padding: 12px 15px;
            border: none;
            border-radius: 12px;
            background-color: white;
            height: 45px;
            box-sizing: border-box;
        }

        .filter-icon {
            background-color: white;
            color: var(--primary-color);
            width: 45px;
            height: 45px;
            border-radius: 50%;
            /* This makes it a circle */
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            flex-shrink: 0;
            /* Prevents the circle from shrinking */
        }

        .filter-icon svg {
            width: 22px;
            height: 22px;
        }

        /* Back Header for inner pages (unaffected by curve) */
        .header.inner-header {
            background-color: #F44336;
            box-shadow: none;
            border-bottom: 1px solid #eee;
            color: #fff;
        }

        .back-icon {
            font-size: 24px;
            cursor: pointer;
        }

        /* --- END OF UPDATED STYLES --- */

        /* Banner Slider */
        .slider-container {
            position: relative;
            width: auto;
            margin: 15px;
            overflow: hidden;
            border-radius: 15px;
        }

        .slider-wrapper {
            display: flex;
            transition: transform 0.5s ease-in-out;
        }

        .slider-wrapper img {
            width: 100%;
            flex-shrink: 0;
            display: block;
            height: 160px;
            object-fit: cover;
        }

        .slider-dots {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
        }

        .dot {
            height: 8px;
            width: 8px;
            margin: 0 4px;
            background-color: rgba(255, 255, 255, 0.5);
            border-radius: 50%;
            display: inline-block;
            cursor: pointer;
            transition: all 0.3s;
        }

        .dot.active {
            background-color: #fff;
            width: 20px;
        }

        /* Section Title */
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 15px 10px 15px;
            background: #fff;
        }

        .section-header h2 {
            font-size: 18px;
            margin: 0;
        }

        .section-header a {
            font-size: 14px;
            color: var(--primary-color);
            text-decoration: none;
        }

        #home-screen .section-header,
        .related-products-section h2 {
            background-color: transparent;
        }

        .related-products-section {
            padding: 0 15px;
        }


        /* Categories */
        .category-container {
            display: flex;
            overflow-x: auto;
            padding: 10px 15px;
            gap: 15px;
            background: #fff;
        }

        .category-item {
            text-align: center;
            flex-shrink: 0;
            cursor: pointer;
        }

        .category-icon-wrapper {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            background-color: var(--light-gray);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 5px;
        }

        .category-icon-wrapper img,
        .category-icon-wrapper svg {
            width: 35px;
            height: 35px;
            object-fit: contain;
            color: var(--primary-color);
        }

        .category-item p {
            margin-top: 5px;
            font-size: 12px;
            color: var(--medium-text);
        }

        /* Product Grid & Cards */
        .product-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            padding: 15px;
        }

        .product-card {
            background: #fff;
            border-radius: 12px;
            overflow: hidden;
        }

        .product-image-container {
            position: relative;
            cursor: pointer;
        }

        .product-card img {
            width: 100%;
            height: 150px;
            object-fit: cover;
            border: 1px solid #f0f0f0;
            border-radius: 12px;
        }

        .product-card .fav-icon {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 22px;
            color: #fff;
            background-color: rgba(0, 0, 0, 0.3);
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
        }

        .product-card .fav-icon.favorited {
            color: var(--danger-color);
            background-color: rgba(255, 255, 255, 0.7);
        }

        .product-card-info {
            padding: 10px 5px;
        }

        .product-card h3 {
            font-size: 14px;
            margin: 0 0 5px 0;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            color: var(--dark-text);
            min-height: 38px;
        }

        .product-rating {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 12px;
            color: var(--medium-text);
            margin-bottom: 5px;
        }

        .product-card p {
            font-size: 16px;
            font-weight: bold;
            margin: 0;
            color: var(--primary-color);
        }

        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            width: 100%;
            background: #fff;
            box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
            z-index: 1000;
        }

        .nav-item {
            cursor: pointer;
            text-align: center;
            color: var(--medium-text);
            font-size: 11px;
        }

        .nav-item.active {
            color: var(--primary-color);
        }

        .nav-item svg {
            width: 24px;
            height: 24px;
            margin-bottom: 2px;
        }

        #product-details-screen.active~.bottom-nav,
        #track-order-screen.active~.bottom-nav,
        #delivery-address-screen.active~.bottom-nav,
        #order-confirmation-screen.active~.bottom-nav {
            display: none;
        }


        /* Product Details */
        #product-details-screen {
            padding-bottom: 20px;
            background-color: #fff;
        }

        .product-image-slider-container {
            position: relative;
        }

        .product-image-slider {
            display: flex;
            overflow-x: auto;
            scroll-snap-type: x mandatory;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
        }

        .product-image-slider::-webkit-scrollbar {
            display: none;
        }

        .product-image-slider img {
            width: 100%;
            height: 300px;
            object-fit: cover;
            scroll-snap-align: center;
            flex-shrink: 0;
        }

        .product-image-indicators {
            position: absolute;
            bottom: 15px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 8px;
        }

        .indicator-dot {
            width: 25px;
            height: 5px;
            background-color: rgba(255, 255, 255, 0.5);
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .indicator-dot.active {
            background-color: #fff;
            width: 40px;
        }

        .details-content {
            padding: 20px;
        }

        .details-title-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .details-title-row h2 {
            margin: 0;
            font-size: 22px;
        }

        .details-price {
            font-size: 20px;
            font-weight: bold;
            color: var(--primary-color);
        }

        .size-selector {
            margin: 20px 0;
        }

        .size-selector button {
            padding: 8px 15px;
            margin-right: 10px;
            border: 1px solid #ccc;
            background: #fff;
            border-radius: 5px;
            cursor: pointer;
        }

        .size-selector button.selected {
            background: var(--primary-color);
            color: #fff;
            border-color: var(--primary-color);
        }

        .description {
            margin: 20px 0;
            line-height: 1.6;
            color: #555;
        }

        .pdp-buttons-container {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .pdp-btn {
            flex: 1;
            text-align: center;
            padding: 15px 0;
            font-size: 16px;
            font-weight: bold;
            border: none;
            cursor: pointer;
            border-radius: 10px;
        }

        .pdp-btn.add-to-cart {
            background: #fff;
            color: var(--primary-color);
            border: 2px solid var(--primary-color);
        }

        .pdp-btn.buy-now {
            background: var(--primary-color);
            color: #fff;
        }


        /* Profile Screen */
        #profile-screen {
            background-color: #fff;
        }

        .profile-page-content {
            padding: 20px;
        }

        .profile-picture-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 30px;
        }

        .profile-picture-wrapper {
            position: relative;
            cursor: pointer;
        }

        .profile-picture-wrapper img {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            object-fit: cover;
        }

        .profile-picture-wrapper .profile-pic-edit {
            position: absolute;
            bottom: 5px;
            right: 5px;
            background-color: var(--primary-color);
            color: white;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            border: 2px solid white;
        }

        .profile-picture-section h3 {
            margin-top: 15px;
            font-size: 20px;
            color: var(--dark-text);
        }

        .profile-page-menu-item {
            display: flex;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
        }

        .profile-page-menu-item svg {
            color: var(--primary-color);
            margin-right: 15px;
            width: 22px;
            height: 22px;
        }

        .profile-page-menu-item span {
            flex-grow: 1;
            font-size: 16px;
            color: var(--dark-text);
        }

        .profile-page-menu-item .chevron {
            font-size: 18px;
            color: var(--medium-text);
        }

        .profile-page-menu-item#logout-btn-new span,
        .profile-page-menu-item#logout-btn-new svg {
            color: var(--danger-color);
        }

        /* Login Form */
        #login-view {
            padding-top: 50px;
            background-color: #fff;
        }

        .form-container {
            padding: 30px;
        }

        #delivery-address-screen .form-container {
            padding-bottom: 120px;
        }

        .form-container h2 {
            text-align: center;
        }

        .form-container input {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-sizing: border-box;
        }

        .form-container button {
            width: 100%;
            padding: 12px;
            background: var(--primary-color);
            color: #fff;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }

        .toggle-form {
            text-align: center;
            margin-top: 15px;
            color: var(--primary-color);
            cursor: pointer;
        }

        /* Cart & Order List Screen */
        .cart-item {
            display: flex;
            background: #fff;
            margin: 10px 15px;
            padding: 10px;
            border-radius: 8px;
            align-items: center;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.05);
            position: relative;
        }

        .cart-item img {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 5px;
            margin-right: 15px;
        }

        .cart-item-info {
            flex-grow: 1;
            cursor: pointer;
        }

        .cart-item-info h4,
        .cart-item-info p {
            margin: 5px 0;
        }

        .empty-cart {
            text-align: center;
            padding: 50px;
            color: #777;
        }

        .buy-now-btn {
            position: fixed;
            bottom: 70px;
            left: 15px;
            right: 15px;
            width: auto;
            background: var(--primary-color);
            color: #fff;
            text-align: center;
            padding: 15px 0;
            font-size: 18px;
            font-weight: bold;
            border: none;
            cursor: pointer;
            border-radius: 10px;
        }

        /* NEW: Remove from cart button style */
        .remove-from-cart-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            cursor: pointer;
            color: var(--danger-color);
            background-color: #fde8e8;
            border-radius: 50%;
            width: 26px;
            height: 26px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .remove-from-cart-btn svg {
            width: 16px;
            height: 16px;
        }

        /* Delivery Address Screen */
        .fixed-bottom-btn {
            position: fixed;
            bottom: 15px;
            left: 15px;
            right: 15px;
            width: auto;
            background: var(--primary-color);
            color: #fff;
            text-align: center;
            padding: 15px 0;
            font-size: 18px;
            font-weight: bold;
            border: none;
            cursor: pointer;
            border-radius: 10px;
        }

        /* NEW: Delivery Info Box */
        .delivery-info-box {
            text-align: center;
            padding: 10px 15px;
            font-size: 14px;
            color: var(--medium-text);
            position: fixed;
            bottom: 75px;
            left: 15px;
            right: 15px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 -1px 3px rgba(0, 0, 0, 0.05);
            z-index: 1001;
        }

        .delivery-info-box strong {
            color: var(--dark-text);
        }

        .payment-options h4 {
            margin-top: 30px;
        }

        .payment-option {
            display: flex;
            align-items: center;
            padding: 15px;
            border: 1px solid #ccc;
            border-radius: 8px;
            margin-bottom: 10px;
            cursor: pointer;
        }

        .payment-option.selected {
            border-color: var(--primary-color);
            background-color: #fee2e2;
            border-width: 2px;
        }

        .payment-option svg {
            width: 24px;
            height: 24px;
            margin-right: 15px;
        }

        .payment-option span {
            flex-grow: 1;
            font-weight: 500;
        }

        .payment-option .radio-check {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 2px solid #ccc;
        }

        .payment-option.selected .radio-check {
            border-color: var(--primary-color);
            background-color: var(--primary-color);
            box-shadow: inset 0 0 0 3px #fff;
        }

        /* Wishlist Filters */
        .filters-container {
            display: flex;
            overflow-x: auto;
            gap: 10px;
            padding: 10px 15px;
            border-bottom: 1px solid #f0f0f0;
            background-color: #fff;
        }

        .filter-btn {
            padding: 8px 18px;
            border: 1px solid #ddd;
            background: #fff;
            border-radius: 20px;
            cursor: pointer;
            white-space: nowrap;
        }

        .filter-btn.active {
            background: var(--primary-color);
            color: #fff;
            border-color: var(--primary-color);
        }

        /* Dialog & Filter Modal */
        .dialog-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .dialog-box {
            background: #fff;
            padding: 30px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            width: 80%;
            max-width: 320px;
        }

        .dialog-box h3 {
            margin-top: 0;
            font-size: 20px;
        }

        .dialog-box p {
            margin: 10px 0 20px;
            color: #555;
        }

        .dialog-box .dialog-buttons {
            display: flex;
            justify-content: space-between;
            gap: 10px;
        }

        .dialog-box button {
            flex: 1;
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
        }

        #dialog-primary-btn,
        .dialog-box .single-button,
        #filter-apply-btn {
            background: var(--primary-color);
            color: #fff;
        }

        #dialog-secondary-btn,
        #filter-cancel-btn {
            background: #eee;
            color: #333;
        }

        .sort-options {
            text-align: left;
            margin: 20px 0;
        }

        .sort-options label {
            display: flex;
            align-items: center;
            padding: 10px 5px;
            cursor: pointer;
            font-size: 16px;
        }

        .sort-options label input {
            margin-right: 15px;
            width: 18px;
            height: 18px;
        }

        /* Track Order Screen Styles */
        #track-order-screen {
            background-color: #fff;
            padding-bottom: 0;
        }

        .track-order-container {
            padding: 20px;
        }

        .order-summary-card {
            display: flex;
            align-items: center;
            gap: 15px;
            padding-bottom: 20px;
        }

        .order-summary-card img {
            width: 60px;
            height: 60px;
            border-radius: 8px;
            object-fit: cover;
        }

        .order-summary-info h4 {
            margin: 0 0 5px 0;
            font-size: 16px;
            color: var(--dark-text);
        }

        .order-summary-info p {
            margin: 0;
            font-size: 14px;
            color: var(--medium-text);
        }

        .order-details-section {
            background-color: var(--light-gray);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 25px;
        }

        .order-detail-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 14px;
        }

        .order-detail-row:not(:last-child) {
            margin-bottom: 10px;
        }

        .order-detail-row span:first-child {
            color: var(--medium-text);
        }

        .order-detail-row span:last-child {
            color: var(--dark-text);
            font-weight: 500;
        }

        .timeline {
            list-style: none;
            padding: 0;
        }

        .timeline-item {
            display: flex;
            gap: 15px;
            position: relative;
        }

        .timeline-item:not(:last-child) {
            padding-bottom: 30px;
        }

        .timeline-connector {
            position: absolute;
            top: 12px;
            left: 11px;
            width: 2px;
            height: 100%;
            background-color: #e5e7eb;
            transition: background-color 0.4s ease;
        }

        .timeline-item.active .timeline-connector {
            background-color: var(--primary-color);
        }

        .timeline-dot {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background-color: #e5e7eb;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1;
            transition: background-color 0.4s ease;
        }

        .timeline-item.active .timeline-dot {
            background-color: var(--primary-color);
        }

        .timeline-dot svg {
            color: #fff;
            width: 14px;
            height: 14px;
            transition: transform 0.3s ease;
            transform: scale(0);
        }

        .timeline-item.active .timeline-dot svg {
            color: #fff;
            transform: scale(1);
        }

        .timeline-item:not(.active) .timeline-dot svg {
            color: #e5e7eb;
            transform: scale(1);
        }

        /* Cancelled State Styles */
        .timeline-item.cancelled .timeline-dot {
            background-color: var(--danger-color);
        }

        .timeline-item.cancelled .timeline-connector {
            background-color: var(--danger-color);
        }

        .timeline-item.cancelled .timeline-icon svg {
            color: var(--danger-color);
        }

        .timeline-item.cancelled .timeline-dot svg {
            transform: scale(1);
        }

        .timeline-content {
            flex-grow: 1;
        }

        .timeline-content h5 {
            margin: 0 0 4px 0;
            color: var(--dark-text);
        }

        .timeline-content p {
            margin: 0;
            font-size: 12px;
            color: var(--medium-text);
        }

        .timeline-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--light-gray);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .timeline-icon svg {
            width: 20px;
            height: 20px;
            color: var(--medium-text);
            transition: color 0.4s ease;
        }

        .timeline-item.active .timeline-icon svg {
            color: var(--primary-color);
        }

        /* Search Results Screen Styles */
        #search-results-screen {
            padding-bottom: 70px;
        }

        #search-results-screen .search-container {
            background-color: #fff;
            border-bottom: 1px solid #f0f0f0;
        }

        #search-results-screen .search-bar {
            background-color: var(--light-gray);
        }

        #search-results-screen .filter-icon {
            background-color: var(--primary-color);
            color: white;
        }

        .search-results-header {
            padding: 10px 15px;
            background-color: #fff;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #f0f0f0;
        }

        .search-results-header .query-text {
            font-size: 14px;
            color: var(--dark-text);
        }

        .search-results-header .query-text span {
            font-weight: bold;
        }

        .search-results-header .count-text {
            font-size: 12px;
            color: var(--medium-text);
        }

        /* NEW: Order Confirmation Screen Styles */
        #order-confirmation-screen {
            background-color: #fff;
            padding: 20px;
        }

        .confirmation-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            height: 90vh;
        }

        .success-icon {
            color: var(--success-color);
            width: 80px;
            height: 80px;
            margin-bottom: 20px;
        }

        .confirmation-title {
            font-size: 24px;
            font-weight: bold;
            color: var(--dark-text);
            margin-bottom: 10px;
        }

        .confirmation-message {
            color: var(--medium-text);
            font-size: 14px;
            margin-bottom: 5px;
        }

        .confirmation-message .link {
            color: var(--success-color);
            font-weight: bold;
            cursor: pointer;
        }

        .delivery-estimate {
            color: var(--medium-text);
            font-size: 14px;
            margin: 15px 0;
        }

        .confirmation-actions .link {
            color: var(--success-color);
            font-weight: bold;
            cursor: pointer;
            display: block;
            margin-bottom: 20px;
        }

        .confirmation-button {
            background-color: var(--success-color);
            color: #fff;
            padding: 15px 40px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
        }

        .confirmation-footer {
            position: absolute;
            bottom: 20px;
            font-size: 12px;
            color: var(--medium-text);
        }

        .confirmation-footer .link {
            color: var(--success-color);
            font-weight: bold;
        }
    </style>
</head>

<body>
    <!-- Home Screen -->
    <div id="home-screen" class="screen active">
        <div class="header-wrapper">
            <div class="header">
                <div id="header-location" class="header-location">
                    <span>Location</span>
                    <span id="location-text">Login to see location</span>
                </div>
                <div class="header-icons">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6 6 0 00-5-5.917V5a1 1 0 00-2 0v.083A6 6 0 006 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path>
                    </svg>
                </div>
            </div>
            <div class="search-container">
                <div class="search-wrapper">
                    <input type="search" id="search-bar" class="search-bar" placeholder="Search for products...">
                    <div class="filter-icon">
                        <svg fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M3 3a1 1 0 011-1h12a1 1 0 011 1v3a1 1 0 01-.293.707L12 11.414V15a1 1 0 01-.293.707l-2 2A1 1 0 018 17v-5.586L3.293 6.707A1 1 0 013 6V3z" clip-rule="evenodd"></path>
                        </svg>
                    </div>
                </div>
            </div>
        </div>
        <div class="slider-container" id="banner-container">
            <div class="slider-wrapper" id="banner-wrapper"></div>
            <div class="slider-dots" id="banner-dots"></div>
        </div>
        <div class="section-header">
            <h2>Category</h2><a href="#">See All</a>
        </div>
        <div class="category-container" id="category-container"></div>
        <div class="section-header">
            <h2 id="product-section-title">All Products</h2>
        </div>
        <div class="product-grid" id="product-grid"></div>
    </div>

    <!-- Search Results Screen -->
    <div id="search-results-screen" class="screen">
        <div class="header inner-header">
            <span class="back-icon" onclick="showScreen('home-screen')">‚Üê</span>
            <span class="title">Search Results</span>
        </div>
        <div class="search-container">
            <div class="search-wrapper">
                <input type="search" id="search-bar-results" class="search-bar" placeholder="Search for products...">
                <div class="filter-icon">
                    <svg fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M3 3a1 1 0 011-1h12a1 1 0 011 1v3a1 1 0 01-.293.707L12 11.414V15a1 1 0 01-.293.707l-2 2A1 1 0 018 17v-5.586L3.293 6.707A1 1 0 013 6V3z" clip-rule="evenodd"></path>
                    </svg>
                </div>
            </div>
        </div>
        <div class="search-results-header">
            <div class="query-text">Search for "<strong><span id="search-query-text"></span></strong>"</div>
            <div class="count-text"><span id="search-results-count">0</span> results</div>
        </div>
        <div class="product-grid" id="search-results-grid"></div>
    </div>

    <!-- Product Details Screen -->
    <div id="product-details-screen" class="screen">
        <div class="header inner-header"><span class="back-icon" onclick="showScreen('home-screen')">‚Üê</span><span class="title">Product Details</span></div>
        <div id="product-details-content"></div>
    </div>

    <!-- Cart Screen -->
    <div id="cart-screen" class="screen">
        <div class="header inner-header"><span class="title">My Cart</span></div>
        <div id="cart-items-container"></div>
        <button id="buy-now-btn" class="buy-now-btn" style="display: none;">Buy Now</button>
    </div>

    <!-- Login/Profile Screen -->
    <div id="profile-screen" class="screen">
        <div id="login-view">
            <div class="form-container" id="login-form">
                <h2>Login</h2>
                <input type="email" id="login-email" placeholder="Email"><input type="password" id="login-password" placeholder="Password"><button id="login-btn">Login</button>
                <p class="toggle-form" onclick="toggleAuthForms()">Don't have an account? Sign Up</p>
            </div>
            <div class="form-container" id="signup-form" style="display: none;">
                <h2>Sign Up</h2>
                <input type="text" id="signup-name" placeholder="Full Name"><input type="email" id="signup-email" placeholder="Email"><input type="password" id="signup-password" placeholder="Password"><button id="signup-btn">Sign Up</button>
                <p class="toggle-form" onclick="toggleAuthForms()">Already have an account? Login</p>
            </div>
        </div>
        <div id="profile-view" style="display: none;">
            <div class="header inner-header"><span class="title">Profile</span></div>
            <div class="profile-page-content">
                <div class="profile-picture-section">
                    <div class="profile-picture-wrapper"><img id="profile-pic-img" src="https://i.pravatar.cc/100" alt="Profile Picture">
                        <div class="profile-pic-edit">‚úé</div>
                    </div>
                    <h3 id="profile-page-name">User Name</h3>
                </div>
                <div id="profile-page-menu" class="profile-page-menu"></div>
            </div>
        </div>
    </div>

    <!-- My Orders Screen -->
    <div id="my-orders-screen" class="screen">
        <div class="header inner-header"><span class="back-icon" onclick="showScreen('profile-screen')">‚Üê</span><span class="title">My Orders</span></div>
        <div id="orders-list-container"></div>
    </div>

    <!-- My Profile Screen -->
    <div id="my-profile-screen" class="screen">
        <div class="header inner-header">
            <span class="back-icon" onclick="showScreen('profile-screen')">‚Üê</span>
            <span class="title">My Profile</span>
        </div>
        <div class="profile-page-content">
            <div class="profile-picture-section">
                <div class="profile-picture-wrapper" id="edit-profile-pic-container">
                    <img id="edit-profile-pic-img" src="https://i.pravatar.cc/100" alt="Profile Picture">
                    <div class="profile-pic-edit">‚úé</div>
                </div>
                <input type="file" id="profile-pic-input" accept="image/*" style="display:none;">
            </div>
            <div class="form-container" style="padding-top: 0;">
                <label for="edit-profile-name" style="display:block; text-align:left; margin-bottom:5px; color: var(--medium-text);">Full Name</label>
                <input type="text" id="edit-profile-name" placeholder="Full Name">
                <button id="save-profile-btn">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Contact Us Screen -->
    <div id="contact-us-screen" class="screen">
        <div class="header inner-header">
            <span class="back-icon" onclick="showScreen('profile-screen')">‚Üê</span>
            <span class="title">Contact Us</span>
        </div>
        <div class="contact-us-content" style="padding: 20px; line-height: 1.6; color: var(--dark-text);">
            <h3>Aapka swagat hai!</h3>
            <p>Humari e-commerce app main jiska naam hai Sachdev Beauty Shoppy apka feedback, suggestions aur sawal humare liye bahut keemti hai. Hum chahte hain ki aapko shopping ka ek smooth, safe aur enjoyable experience mile. Agar aapko kisi product, payment, delivery, account, ya kisi bhi feature ko lekar koi confusion, dikkat ya sawal ho, to bina jhijhak humse sampark karein.</p>
            <p>Hum hamesha aapki madad ke liye tayar hain. Chahe aapko technical support chahiye ho, kisi order ke status ke baare mein jaankari chahiye ho, ya bas apna feedback dena ho ‚Äì hum aapki baat sunenge aur jitni jaldi ho sake utni jaldi response denge.</p>
            <p>Aap humein neeche diye gaye email par message kar sakte hain:</p>
            <p>üìß Email: <strong>jatinsachdev777@gmail.com</strong></p>
            <p>Humara goal hai ki aapko ek personalized aur reliable shopping service mile. Aapka experience humare liye priority hai, isliye aapke sujhav aur sawal humare liye guidance ka kaam karte hain. Agar aapko kisi chiz ki zarurat ho, kisi problem ka solution chahiye, ya bas humein kuch batana ho, to zarur likhiye.</p>
            <p>Aapka trust aur support hi humein behtar banata hai. Hum chahte hain ki aap har baar shopping karte waqt confident mehsoos karein. Aapki har query ko dhyan se padha jayega aur uska samadhan dene ki koshish ki jayegi.</p>
            <p>Aap humein email likhkar apne anubhav share karein Ya '8237762744' ispe contact kare ‚Äì hum aapke sawalon ka jawab dene aur aapko behtareen seva pradan karne ke liye hamesha yahan hain!</p>
        </div>
    </div>

    <!-- Favorites Screen -->
    <div id="favorites-screen" class="screen">
        <div class="header inner-header"><span class="back-icon" onclick="showScreen('home-screen')">‚Üê</span><span class="title">My Wishlist</span></div>
        <div id="favorites-filter-container" class="filters-container"></div>
        <div class="product-grid" id="favorites-grid"></div>
    </div>

    <!-- Delivery Address Screen -->
    <div id="delivery-address-screen" class="screen">
        <div class="header inner-header"><span class="back-icon" onclick="showScreen('cart-screen')">‚Üê</span><span class="title">Delivery Address</span></div>
        <div class="form-container">
            <input type="text" id="delivery-name" placeholder="Full Name">
            <input type="tel" id="delivery-mobile" placeholder="Mobile Number">
            <input type="text" id="delivery-village" placeholder="Village / Town">
            <input type="text" id="delivery-area" placeholder="Area / Locality">
            <input type="tel" id="delivery-pincode" placeholder="Pincode">
            <input type="text" id="delivery-block" placeholder="Block">
            <input type="text" id="delivery-district" placeholder="District">
            <input type="text" id="delivery-state" placeholder="State">
            <div class="payment-options">
                <h4>Payment Mode</h4>
                <div class="payment-option selected" data-value="COD"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M17 9.5a2.5 2.5 0 0 1-5 0M2 6h20M2 10h20M2 14h20M2 18h20M7 2v4M17 2v4" />
                    </svg><span>Cash on Delivery</span>
                    <div class="radio-check"></div>
                </div>
                <div class="payment-option" data-value="ONLINE"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect>
                        <line x1="1" y1="10" x2="23" y2="10"></line>
                    </svg><span>Pay Online</span>
                    <div class="radio-check"></div>
                </div>
            </div>
        </div>
        <div id="delivery-info-container" class="delivery-info-box"></div>
        <button id="submit-order-btn" class="fixed-bottom-btn">Confirm Order</button>
    </div>

    <!-- Track Order Screen -->
    <div id="track-order-screen" class="screen">
        <div class="header inner-header"><span class="back-icon" onclick="showScreen('my-orders-screen')">‚Üê</span><span class="title">Track Order</span></div>
        <div id="track-order-content"></div>
    </div>

    <!-- NEW: Order Confirmation Screen -->
    <div id="order-confirmation-screen" class="screen">
        <div class="confirmation-container">
            <svg class="success-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            <h2 class="confirmation-title">Order Confirmed !</h2>
            <p class="confirmation-message">Your order has been placed successfully. <span id="conf-order-history-link" class="link">Order History</span></p>
            <p id="delivery-estimate-text" class="delivery-estimate">Get delivery by Mon, 06 Feb - Thu, 09 Feb</p>
            <div class="confirmation-actions">
                <span id="conf-track-order-btn" class="link">Track My Order</span>
                <button id="conf-continue-shopping-btn" class="confirmation-button">Continue Shopping</button>
            </div>
            <div class="confirmation-footer">
                <p>Have any questions? Reach directly to our <span class="link">Customer Support</span></p>
            </div>
        </div>
    </div>


    <!-- Reusable Dialog -->
    <div id="dialog-overlay" class="dialog-overlay">
        <div class="dialog-box">
            <h3 id="dialog-title"></h3>
            <p id="dialog-message"></p>
            <div class="dialog-buttons"><button id="dialog-secondary-btn"></button><button id="dialog-primary-btn"></button></div>
            <button id="dialog-single-btn" class="single-button"></button>
        </div>
    </div>

    <!-- NEW: Filter Modal -->
    <div id="filter-modal-overlay" class="dialog-overlay">
        <div class="dialog-box">
            <h3>Sort Products</h3>
            <div class="sort-options">
                <label><input type="radio" name="sort" value="default" checked> Recommended</label>
                <label><input type="radio" name="sort" value="low-to-high"> Price: Low to High</label>
                <label><input type="radio" name="sort" value="high-to-low"> Price: High to Low</label>
            </div>
            <div class="dialog-buttons">
                <button id="filter-cancel-btn">Cancel</button>
                <button id="filter-apply-btn">Apply</button>
            </div>
        </div>
    </div>


    <!-- Bottom Navigation Bar -->
    <div class="bottom-nav">
        <div id="nav-home" class="nav-item active" onclick="showScreen('home-screen')"><svg fill="currentColor" viewBox="0 0 20 20">
                <path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"></path>
            </svg>
            <div>Home</div>
        </div>
        <div id="nav-wishlist" class="nav-item" onclick="handleFavoritesClick()"><svg fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z" clip-rule="evenodd"></path>
            </svg>
            <div>Wishlist</div>
        </div>
        <div id="nav-cart" class="nav-item" onclick="showScreen('cart-screen')"><svg fill="currentColor" viewBox="0 0 20 20">
                <path d="M3 1a1 1 0 000 2h1.22l.305 1.222a.997.997 0 00.01.042l1.358 5.43-.893.892C3.74 11.846 4.632 14 6.414 14H15a1 1 0 000-2H6.414l1-1H14a1 1 0 00.894-.553l3-6A1 1 0 0017 3H6.28l-.31-1.243A1 1 0 005 1H3zM16 16.5a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0zM6.5 18a1.5 1.5 0 100-3 1.5 1.5 0 000 3z"></path>
            </svg>
            <div>Cart</div>
        </div>
        <div id="nav-profile" class="nav-item" onclick="handleProfileClick()"><svg fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"></path>
            </svg>
            <div>Profile</div>
        </div>
    </div>

    <script type="module">
        import {
            initializeApp
        } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import {
            getAuth,
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            onAuthStateChanged,
            signOut
        } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
        import {
            getDatabase,
            ref,
            set,
            get,
            onValue,
            push,
            query,
            equalTo,
            orderByChild,
            update
        } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js";
        import {
            getStorage,
            ref as storageRef,
            uploadBytes,
            getDownloadURL
        } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-storage.js";
        //Firebase Details (Replace karo)
        const firebaseConfig = {
            apiKey: "AIzaSyA4fYquRurtS58GweH_x60QzDr8tegezdg",
            authDomain: "e-commerce-3f7d4.firebaseapp.com",
            projectId: "e-commerce-3f7d4",
            storageBucket: "e-commerce-3f7d4.firebasestorage.app",
            messagingSenderId: "301794965783",
            appId: "1:301794965783:web:6960953162165333f3df52",
            measurementId: "G-W7S3848F36"
        };
        //Rajorpazorpay ki Key Replace karo
        const razorpayKey = 'rzp_live_RTTaIMv2bEMUKT';
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);
        const storage = getStorage(app);
        let currentUser = null,
            currentProduct = null,
            userFavorites = [],
            allProducts = {},
            allCategories = {};
        let activeOrderListener = null;
        let checkoutItems = null;
        let isCheckoutFromCart = false;

        // --- NEW FILTER/SORT VARIABLES ---
        let currentlyDisplayedProducts = {};
        let activeSortOrder = 'default'; // 'default', 'low-to-high', 'high-to-low'
        let lastUsedContainerId = 'product-grid';


        // --- SCREEN NAVIGATION ---
        window.showScreen = (screenId) => {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            const navId = `nav-${screenId.split('-')[0]}`;
            if (document.getElementById(navId)) document.getElementById(navId).classList.add('active');
            if (screenId === 'favorites-screen') document.getElementById('nav-wishlist').classList.add('active');
            if (activeOrderListener && screenId !== 'track-order-screen') {
                activeOrderListener();
                activeOrderListener = null;
            }
        }

        // --- DIALOG CONTROL ---
        const dialogOverlay = document.getElementById('dialog-overlay'),
            dialogTitle = document.getElementById('dialog-title'),
            dialogMessage = document.getElementById('dialog-message'),
            dialogPrimaryBtn = document.getElementById('dialog-primary-btn'),
            dialogSecondaryBtn = document.getElementById('dialog-secondary-btn'),
            dialogSingleBtn = document.getElementById('dialog-single-btn');

        function showDialog({
            title,
            message,
            primaryBtnText,
            onPrimaryClick,
            secondaryBtnText,
            onSecondaryClick
        }) {
            dialogTitle.textContent = title;
            dialogMessage.textContent = message;
            dialogSingleBtn.style.display = 'none';
            dialogPrimaryBtn.style.display = 'none';
            dialogSecondaryBtn.style.display = 'none';
            if (primaryBtnText && secondaryBtnText) {
                dialogPrimaryBtn.parentElement.style.display = 'flex';
                dialogSingleBtn.style.display = 'none';
                dialogPrimaryBtn.style.display = 'block';
                dialogSecondaryBtn.style.display = 'block';
                dialogPrimaryBtn.textContent = primaryBtnText;
                dialogSecondaryBtn.textContent = secondaryBtnText;
                dialogPrimaryBtn.onclick = () => {
                    onPrimaryClick();
                    closeDialog();
                };
                dialogSecondaryBtn.onclick = () => {
                    if (onSecondaryClick) onSecondaryClick();
                    closeDialog();
                };
            } else if (primaryBtnText) {
                dialogPrimaryBtn.parentElement.style.display = 'none';
                dialogSingleBtn.style.display = 'block';
                dialogSingleBtn.textContent = primaryBtnText;
                dialogSingleBtn.onclick = () => {
                    onPrimaryClick();
                    closeDialog();
                };
            }
            dialogOverlay.style.display = 'flex';
        }

        function closeDialog() {
            dialogOverlay.style.display = 'none';
        }

        // --- AUTHENTICATION & PROFILE ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('profile-view').style.display = 'block';
                document.getElementById('login-view').style.display = 'none';
                onValue(ref(db, `users/${user.uid}`), (snapshot) => {
                    if (snapshot.exists()) {
                        const userData = snapshot.val();
                        document.getElementById('profile-page-name').textContent = userData.name || "User";
                        document.getElementById('profile-pic-img').src = userData.profilePicUrl || 'https://i.pravatar.cc/100';
                        if (userData.address) {
                            document.getElementById('location-text').textContent = `${userData.address.village}, ${userData.address.state}`;
                        } else {
                            document.getElementById('location-text').textContent = "Set your address";
                        }
                    }
                });
                renderProfileMenu();
                loadFavorites();
                loadCart();
            } else {
                currentUser = null;
                document.getElementById('profile-view').style.display = 'none';
                document.getElementById('login-view').style.display = 'block';
                document.getElementById('location-text').textContent = "Login to see location";
            }
        });

        function renderProfileMenu() {
            const menuContainer = document.getElementById('profile-page-menu');
            const menuItems = [{
                    id: 'my-profile-btn',
                    icon: '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>',
                    text: 'My Profile',
                    action: () => showMyProfileScreen()
                },
                {
                    id: 'manage-address',
                    icon: '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>',
                    text: 'Manage Address',
                    action: () => {
                        handleCheckout({}, false);
                    }
                },
                {
                    id: 'my-orders-btn',
                    icon: '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path></svg>',
                    text: 'My Orders',
                    action: () => {
                        loadMyOrders();
                        showScreen('my-orders-screen');
                    }
                },
                {
                    id: 'contact-us-btn',
                    icon: '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg>',
                    text: 'Contact Us',
                    action: () => showScreen('contact-us-screen')
                },
                {
                    id: 'logout-btn-new',
                    icon: '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>',
                    text: 'Logout',
                    action: () => signOut(auth)
                }
            ];
            menuContainer.innerHTML = menuItems.map(item => `<div class="profile-page-menu-item" id="${item.id}">${item.icon}<span>${item.text}</span><span class="chevron">></span></div>`).join('');
            menuItems.forEach(item => document.getElementById(item.id).onclick = item.action);
        }

        let selectedProfileFile = null;

        function showMyProfileScreen() {
            if (!currentUser) return;
            selectedProfileFile = null;

            const nameInput = document.getElementById('edit-profile-name');
            const picImg = document.getElementById('edit-profile-pic-img');

            get(ref(db, `users/${currentUser.uid}`)).then(snapshot => {
                if (snapshot.exists()) {
                    const userData = snapshot.val();
                    nameInput.value = userData.name || '';
                    picImg.src = userData.profilePicUrl || 'https://i.pravatar.cc/100';
                }
            });

            showScreen('my-profile-screen');
        }

        document.getElementById('edit-profile-pic-container').addEventListener('click', () => {
            document.getElementById('profile-pic-input').click();
        });

        document.getElementById('profile-pic-input').addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                selectedProfileFile = file;
                const reader = new FileReader();
                reader.onload = (e) => {
                    document.getElementById('edit-profile-pic-img').src = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        });

        document.getElementById('save-profile-btn').addEventListener('click', async () => {
            if (!currentUser) return;

            const newName = document.getElementById('edit-profile-name').value.trim();
            if (!newName) {
                alert("Name cannot be empty.");
                return;
            }

            const saveBtn = document.getElementById('save-profile-btn');
            saveBtn.disabled = true;
            saveBtn.textContent = 'Saving...';

            try {
                const updates = {};
                updates[`/users/${currentUser.uid}/name`] = newName;

                if (selectedProfileFile) {
                    const fileRef = storageRef(storage, `profile_pictures/${currentUser.uid}`);
                    await uploadBytes(fileRef, selectedProfileFile);
                    const downloadURL = await getDownloadURL(fileRef);
                    updates[`/users/${currentUser.uid}/profilePicUrl`] = downloadURL;
                }

                await update(ref(db), updates);

                showDialog({
                    title: "Success",
                    message: "Profile updated successfully!",
                    primaryBtnText: "OK",
                    onPrimaryClick: () => showScreen('profile-screen')
                });

            } catch (error) {
                console.error("Error updating profile: ", error);
                showDialog({
                    title: "Error",
                    message: `Failed to update profile. This is often due to storage security rules in Firebase. Please check the console for errors. Code: ${error.code || 'UNKNOWN'}`,
                    primaryBtnText: "OK",
                    onPrimaryClick: () => {}
                });
            } finally {
                saveBtn.disabled = false;
                saveBtn.textContent = 'Save Changes';
            }
        });


        window.handleProfileClick = () => showScreen('profile-screen');
        document.getElementById('signup-btn').addEventListener('click', () => {
            const name = document.getElementById('signup-name').value,
                email = document.getElementById('signup-email').value,
                password = document.getElementById('signup-password').value;
            if (!name) return alert('Please enter your name.');
            createUserWithEmailAndPassword(auth, email, password).then(cred => set(ref(db, 'users/' + cred.user.uid), {
                name,
                email
            })).catch(err => alert(err.message));
        });
        document.getElementById('login-btn').addEventListener('click', () => signInWithEmailAndPassword(auth, document.getElementById('login-email').value, document.getElementById('login-password').value).catch(err => alert(err.message)));
        window.toggleAuthForms = () => {
            ['login-form', 'signup-form'].forEach(id => document.getElementById(id).style.display = document.getElementById(id).style.display === 'none' ? 'block' : 'none');
        }

        // --- BANNER SLIDER ---
        let slideIndex = 0,
            slideInterval;

        function showSlide(n) {
            const wrapper = document.getElementById('banner-wrapper'),
                dots = document.querySelectorAll('.dot');
            if (!wrapper || dots.length === 0) return;
            if (n >= dots.length) slideIndex = 0;
            if (n < 0) slideIndex = dots.length - 1;
            wrapper.style.transform = `translateX(${-slideIndex * 100}%)`;
            dots.forEach(dot => dot.classList.remove('active'));
            if (dots[slideIndex]) dots[slideIndex].classList.add('active');
        }

        function startSlider() {
            stopSlider();
            slideInterval = setInterval(() => {
                slideIndex++;
                showSlide(slideIndex);
            }, 4000);
        }

        function stopSlider() {
            clearInterval(slideInterval);
        }

        function loadBanners() {
            onValue(ref(db, 'banners'), (snapshot) => {
                const wrapper = document.getElementById('banner-wrapper'),
                    dotsContainer = document.getElementById('banner-dots');
                wrapper.innerHTML = '';
                dotsContainer.innerHTML = '';
                let i = 0;
                snapshot.forEach(child => {
                    wrapper.innerHTML += `<img src="${child.val().imageUrl}" alt="Banner">`;
                    const dot = document.createElement('span');
                    dot.className = 'dot';
                    dot.onclick = () => {
                        slideIndex = i;
                        showSlide(slideIndex);
                        stopSlider();
                        startSlider();
                    };
                    dotsContainer.appendChild(dot);
                    i++;
                });
                if (i > 0) {
                    slideIndex = 0;
                    showSlide(slideIndex);
                    startSlider();
                }
                document.getElementById('banner-container').onmouseover = stopSlider;
                document.getElementById('banner-container').onmouseout = startSlider;
            });
        }

        // --- DATA LOADING & RENDERING ---
        function loadCategories() {
            onValue(ref(db, 'categories'), s => {
                const c = document.getElementById('category-container');
                c.innerHTML = '';
                allCategories = s.val();
                const allEl = document.createElement('div');
                allEl.className = 'category-item';
                allEl.innerHTML = `<div class="category-icon-wrapper"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg></div><p>All</p>`;
                allEl.onclick = () => {
                    activeSortOrder = 'default';
                    displayProducts(allProducts);
                    document.getElementById('product-section-title').textContent = "All Products";
                };
                c.appendChild(allEl);
                s.forEach(child => {
                    const cat = child.val();
                    const el = document.createElement('div');
                    el.className = 'category-item';
                    el.innerHTML = `<div class="category-icon-wrapper"><img src="${cat.imageUrl}" alt="${cat.name}"></div><p>${cat.name}</p>`;
                    el.onclick = () => filterProductsByCategory(cat.name);
                    c.appendChild(el);
                });
            });
        }

        function loadProducts() {
            onValue(ref(db, 'products'), s => {
                if (s.exists()) {
                    allProducts = s.val();
                    displayProducts(allProducts);
                } else {
                    document.getElementById('product-grid').innerHTML = "<p class='empty-cart'>No products available right now.</p>";
                }
            });
        }

        function displayProducts(productsObject, containerId = 'product-grid') {
            currentlyDisplayedProducts = productsObject;
            lastUsedContainerId = containerId;

            let productsToRender = Object.entries(productsObject).map(([id, data]) => ({
                id,
                ...data
            }));

            if (activeSortOrder === 'low-to-high') {
                productsToRender.sort((a, b) => a.price - b.price);
            } else if (activeSortOrder === 'high-to-low') {
                productsToRender.sort((a, b) => b.price - a.price);
            }

            const g = document.getElementById(containerId);
            g.innerHTML = '';

            if (!productsToRender || productsToRender.length === 0) {
                g.innerHTML = "<p class='empty-cart'>No products found.</p>";
                return;
            }

            productsToRender.forEach(p => {
                const id = p.id;
                if (!p || !p.imageUrls || !p.imageUrls[0]) return;
                const card = document.createElement('div');
                card.className = 'product-card';
                // THIS IS THE MODIFIED LINE
                card.innerHTML = `<div class="product-image-container"><img src="${p.imageUrls[0]}"><span class="fav-icon ${userFavorites.includes(id) ? 'favorited' : ''}" data-product-id="${id}">‚ô•</span></div><div class="product-card-info"><h3>${p.title}</h3><p>‚Çπ${p.price}</p></div>`;
                card.querySelector('.product-image-container').onclick = (e) => {
                    // Prevent triggering click when favorite icon is clicked
                    if (!e.target.classList.contains('fav-icon')) {
                        showProductDetails(id, p);
                    }
                };
                g.appendChild(card);
            });
        }

        // --- PRODUCT DETAILS & CART ---
        window.showProductDetails = (id, product) => {
            currentProduct = {
                id,
                ...product
            };
            const c = document.getElementById('product-details-content');

            const sliderHTML = `<div id="pdp-image-slider" class="product-image-slider">${product.imageUrls.map(u => `<img src="${u}">`).join('')}</div>`;
            const indicatorsHTML = product.imageUrls.length > 1 ? `<div class="product-image-indicators">${product.imageUrls.map((_, index) => `<span class="indicator-dot ${index === 0 ? 'active' : ''}" data-index="${index}"></span>`).join('')}</div>` : '';
            const sH = product.sizes ? `<div class="size-selector">${product.sizes.map(s => `<button class="size-btn">${s}</button>`).join('')}</div>` : '';

            const detailsHTML = `
                <div class="details-content">
                    <div class="details-title-row"><h2>${product.title}</h2><span class="details-price">‚Çπ${product.price}</span></div>
                    ${sH}
                    <div class="description"><h4>Description</h4><p>${product.description}</p></div>
                    <div class="pdp-buttons-container">
                        <button class="pdp-btn add-to-cart" id="pdp-add-to-cart-btn">Add to Cart</button>
                        <button class="pdp-btn buy-now" id="pdp-buy-now-btn">Buy Now</button>
                    </div>
                </div>
                <div class="related-products-section">
                    <h2>Related Products</h2>
                    <div class="product-grid" id="related-products-grid"></div>
                </div>
            `;

            c.innerHTML = `<div class="product-image-slider-container">${sliderHTML}${indicatorsHTML}</div>${detailsHTML}`;

            showScreen('product-details-screen');

            document.getElementById('pdp-add-to-cart-btn').onclick = () => {
                if (!currentUser) {
                    alert("Please login to add items to cart.");
                    showScreen('profile-screen');
                    return;
                }
                const size = document.querySelector('.size-btn.selected')?.innerText;
                if (currentProduct.sizes && !size) {
                    alert('Please select a size.');
                    return;
                }
                set(ref(db, `carts/${currentUser.uid}/${currentProduct.id}`), {
                    ...currentProduct,
                    selectedSize: size
                }).then(() => {
                    showDialog({
                        title: "Success!",
                        message: "Product added to your cart.",
                        primaryBtnText: "Go to Cart",
                        onPrimaryClick: () => showScreen('cart-screen'),
                        secondaryBtnText: "Continue Shopping"
                    });
                });
            };
            document.getElementById('pdp-buy-now-btn').onclick = () => {
                if (!currentUser) {
                    alert("Please login to buy products.");
                    showScreen('profile-screen');
                    return;
                }
                const size = document.querySelector('.size-btn.selected')?.innerText;
                if (currentProduct.sizes && !size) {
                    alert('Please select a size.');
                    return;
                }
                const itemForCheckout = {
                    [currentProduct.id]: {
                        ...currentProduct,
                        selectedSize: size
                    }
                };
                handleCheckout(itemForCheckout, false);
            };

            document.querySelectorAll('.size-btn').forEach(b => b.onclick = e => {
                document.querySelectorAll('.size-btn').forEach(btn => btn.classList.remove('selected'));
                e.target.classList.add('selected');
            });

            if (product.imageUrls.length > 1) {
                const slider = document.getElementById('pdp-image-slider');
                const dots = c.querySelectorAll('.indicator-dot');
                dots.forEach(dot => {
                    dot.onclick = (e) => {
                        const index = parseInt(e.target.dataset.index, 10);
                        slider.scrollTo({
                            left: index * slider.offsetWidth,
                            behavior: 'smooth'
                        });
                    }
                });
                let scrollTimeout;
                slider.onscroll = () => {
                    clearTimeout(scrollTimeout);
                    scrollTimeout = setTimeout(() => {
                        const currentIndex = Math.round(slider.scrollLeft / slider.offsetWidth);
                        dots.forEach((d, i) => d.classList.toggle('active', i === currentIndex));
                    }, 60);
                };
            }

            const relatedProducts = {};
            for (const productId in allProducts) {
                if (allProducts[productId].category === product.category && productId !== id) {
                    relatedProducts[productId] = allProducts[productId];
                }
            }
            displayProducts(relatedProducts, 'related-products-grid');
        }

        function loadCart() {
            if (!currentUser) return;
            onValue(ref(db, `carts/${currentUser.uid}`), s => {
                const c = document.getElementById('cart-items-container');
                const btn = document.getElementById('buy-now-btn');
                c.innerHTML = '';
                if (!s.exists() || s.val() === null) {
                    c.innerHTML = `<p class="empty-cart">Your cart is empty.</p>`;
                    btn.style.display = 'none';
                    return;
                }
                let total = 0;
                const removeIconSVG = `<svg fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd"></path></svg>`;

                s.forEach(cs => {
                    const id = cs.key,
                        i = cs.val(),
                        el = document.createElement('div');
                    el.className = 'cart-item';

                    const itemContent = document.createElement('div');
                    itemContent.className = 'cart-item-info'
                    itemContent.innerHTML = `<img src="${i.imageUrls[0]}"><div class="cart-item-info"><h4>${i.title} ${i.selectedSize?`(${i.selectedSize})`:''}</h4><p>‚Çπ${i.price}</p></div>`;
                    itemContent.onclick = () => showProductDetails(id, i);

                    const removeBtn = document.createElement('div');
                    removeBtn.className = 'remove-from-cart-btn';
                    removeBtn.dataset.productId = id;
                    removeBtn.innerHTML = removeIconSVG;

                    el.appendChild(itemContent);
                    el.appendChild(removeBtn);
                    c.appendChild(el);

                    total += i.price;
                });

                btn.style.display = 'block';
                btn.innerHTML = `Buy Now (Total: ‚Çπ${total})`;
            });
        }

        // --- FAVORITES (WISHLIST) ---
        function loadFavorites() {
            if (!currentUser) return;
            onValue(ref(db, `favorites/${currentUser.uid}`), s => {
                userFavorites = s.exists() ? Object.keys(s.val()) : [];
                // This listener keeps the local state in sync with the database.
                // If a change happens in another tab, we re-render the current product view to reflect it.
                if (document.getElementById(lastUsedContainerId)?.offsetParent !== null) {
                    displayProducts(currentlyDisplayedProducts, lastUsedContainerId);
                }
            });
        }

        function toggleFavorite(productId) {
            if (!currentUser) {
                alert("Please login to save favorites.");
                showScreen('profile-screen');
                return;
            }

            const favRef = ref(db, `favorites/${currentUser.uid}/${productId}`);
            const isCurrentlyFavorited = userFavorites.includes(productId);

            // 1. Optimistic UI Update: Change the UI and local state immediately.
            if (isCurrentlyFavorited) {
                // Remove from local array
                userFavorites = userFavorites.filter(id => id !== productId);
                // Update all matching icons on the page
                document.querySelectorAll(`.fav-icon[data-product-id="${productId}"]`).forEach(icon => icon.classList.remove('favorited'));
            } else {
                // Add to local array
                userFavorites.push(productId);
                // Update all matching icons on the page
                document.querySelectorAll(`.fav-icon[data-product-id="${productId}"]`).forEach(icon => icon.classList.add('favorited'));
            }

            // 2. Sync with Firebase in the background.
            set(favRef, !isCurrentlyFavorited ? true : null).catch(error => {
                // 3. If Firebase update fails, revert the changes.
                console.error("Failed to update favorite status:", error);
                if (isCurrentlyFavorited) { // Revert the "unfavorite" action
                    userFavorites.push(productId);
                    document.querySelectorAll(`.fav-icon[data-product-id="${productId}"]`).forEach(icon => icon.classList.add('favorited'));
                } else { // Revert the "favorite" action
                    userFavorites = userFavorites.filter(id => id !== productId);
                    document.querySelectorAll(`.fav-icon[data-product-id="${productId}"]`).forEach(icon => icon.classList.remove('favorited'));
                }
                alert("Could not update wishlist. Please try again.");
            });
        }

        window.handleFavoritesClick = async () => {
            if (!currentUser) {
                alert("Please login to view your wishlist.");
                return showScreen('profile-screen');
            }
            showScreen('favorites-screen');
            const favSnapshot = await get(ref(db, `favorites/${currentUser.uid}`));
            if (!favSnapshot.exists()) {
                document.getElementById('favorites-grid').innerHTML = `<p class="empty-cart">You have no saved favorites.</p>`;
                document.getElementById('favorites-filter-container').innerHTML = '';
                return;
            }
            const favIds = Object.keys(favSnapshot.val()),
                favoriteProducts = {};
            favIds.forEach(id => {
                if (allProducts[id]) favoriteProducts[id] = allProducts[id];
            });
            renderFavoriteFilters(favoriteProducts);
            displayProducts(favoriteProducts, 'favorites-grid');
        };

        function renderFavoriteFilters(favoriteProducts) {
            const filterContainer = document.getElementById('favorites-filter-container');
            const categoriesInFavorites = [...new Set(Object.values(favoriteProducts).map(p => p.category))];
            filterContainer.innerHTML = `<button class="filter-btn active">All</button>` + categoriesInFavorites.map(catName => `<button class="filter-btn">${catName}</button>`).join('');
            filterContainer.querySelectorAll('.filter-btn').forEach(btn => {
                btn.onclick = (e) => {
                    filterContainer.querySelector('.active').classList.remove('active');
                    e.target.classList.add('active');
                    const category = e.target.textContent;
                    if (category === 'All') {
                        displayProducts(favoriteProducts, 'favorites-grid');
                    } else {
                        const filtered = {};
                        for (const id in favoriteProducts) {
                            if (favoriteProducts[id].category === category) filtered[id] = favoriteProducts[id];
                        }
                        displayProducts(filtered, 'favorites-grid');
                    }
                };
            });
        }

        // --- CHECKOUT AND ORDER ---
        function handleCheckout(items, fromCart) {
            if (!currentUser) {
                alert("Please login to checkout.");
                showScreen('profile-screen');
                return;
            }
            checkoutItems = items;
            isCheckoutFromCart = fromCart;
            showScreen('delivery-address-screen');
            updateExpectedDeliveryDate();
            get(ref(db, `users/${currentUser.uid}/address`)).then(s => {
                if (s.exists()) {
                    const adr = s.val();
                    Object.keys(adr).forEach(k => {
                        const el = document.getElementById(`delivery-${k}`);
                        if (el) el.value = adr[k];
                    });
                }
            });
        }

        function updateExpectedDeliveryDate() {
            const dateContainer = document.getElementById('delivery-info-container');
            if (!dateContainer) return;
            const today = new Date();
            const deliveryDate = new Date();
            deliveryDate.setDate(today.getDate() + 7);
            const options = {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            };
            const formattedDate = deliveryDate.toLocaleDateString('en-GB', options);
            dateContainer.innerHTML = `Expected Delivery by: <strong>${formattedDate}</strong>`;
        }

        document.getElementById('buy-now-btn').addEventListener('click', async () => {
            const cartSnapshot = await get(ref(db, `carts/${currentUser.uid}`));
            if (cartSnapshot.exists()) {
                handleCheckout(cartSnapshot.val(), true);
            } else {
                alert("Your cart is empty.");
            }
        });

        async function fetchPincodeDetails() {
            const pincodeEl = document.getElementById('delivery-pincode');
            const districtEl = document.getElementById('delivery-district');
            const stateEl = document.getElementById('delivery-state');
            const pincode = pincodeEl.value;

            if (pincode.length === 6) {
                try {
                    const response = await fetch(`https://api.postalpincode.in/pincode/${pincode}`);
                    const data = await response.json();

                    if (data && data[0].Status === "Success") {
                        const postOffice = data[0].PostOffice[0];
                        districtEl.value = postOffice.District;
                        stateEl.value = postOffice.State;
                    } else {
                        showDialog({
                            title: "Invalid Pincode",
                            message: "The entered Pincode is not valid. Please check and try again.",
                            primaryBtnText: "OK",
                            onPrimaryClick: () => {}
                        });
                        districtEl.value = '';
                        stateEl.value = '';
                    }
                } catch (error) {
                    console.error("Error fetching pincode details:", error);
                    showDialog({
                        title: "Error",
                        message: "Could not fetch location details. Please enter them manually.",
                        primaryBtnText: "OK",
                        onPrimaryClick: () => {}
                    });
                }
            }
        }

        document.getElementById('submit-order-btn').addEventListener('click', async () => {
            if (!currentUser) return;
            const mobileNumber = document.getElementById('delivery-mobile').value;
            const pincode = document.getElementById('delivery-pincode').value;

            if (mobileNumber.length !== 10) {
                alert('Please enter a valid 10-digit mobile number.');
                return;
            }

            if (pincode.length !== 6) {
                alert('Please enter a valid 6-digit pincode.');
                return;
            }

            const adr = {
                name: document.getElementById('delivery-name').value,
                mobile: mobileNumber,
                village: document.getElementById('delivery-village').value,
                area: document.getElementById('delivery-area').value,
                pincode: pincode,
                block: document.getElementById('delivery-block').value,
                district: document.getElementById('delivery-district').value,
                state: document.getElementById('delivery-state').value,
            };

            if (Object.values(adr).some(f => !f)) {
                return alert('Please fill all address fields.');
            }

            set(ref(db, `users/${currentUser.uid}/address`), adr);
            const mode = document.querySelector('.payment-option.selected').dataset.value;
            if (!checkoutItems) return alert('Checkout error: No items selected.');
            const total = Object.values(checkoutItems).reduce((sum, i) => sum + i.price, 0);
            const orderDate = new Date().toISOString();
            const oData = {
                userId: currentUser.uid,
                userEmail: currentUser.email,
                items: checkoutItems,
                address: adr,
                totalAmount: total,
                paymentMode: mode,
                status: 'Order Placed',
                orderDate,
                statusHistory: {
                    'Order Placed': orderDate
                }
            };

            if (mode === 'COD') {
                placeOrder(oData, isCheckoutFromCart);
            } else {
                new Razorpay({
                    key: razorpayKey,
                    amount: total * 100,
                    currency: "INR",
                    name: "Sachdev Beauty Shoppy",
                    handler: r => {
                        oData.paymentId = r.razorpay_payment_id;
                        placeOrder(oData, isCheckoutFromCart);
                    },
                    prefill: {
                        name: adr.name,
                        email: currentUser.email,
                        contact: adr.mobile
                    },
                    theme: {
                        color: "#ef4444"
                    }
                }).open();
            }
        });

        function placeOrder(orderData, clearCart) {
            const newOrderRef = push(ref(db, 'orders'));
            set(newOrderRef, orderData).then(() => {
                if (clearCart) {
                    set(ref(db, `carts/${currentUser.uid}`), null);
                }
                showOrderConfirmation(newOrderRef.key);
            });
        }

        function showOrderConfirmation(orderId) {
            const today = new Date();
            const startDelivery = new Date();
            startDelivery.setDate(today.getDate() + 4);
            const endDelivery = new Date();
            endDelivery.setDate(today.getDate() + 7);
            const options = {
                weekday: 'short',
                day: 'numeric',
                month: 'short'
            };
            const formattedStartDate = startDelivery.toLocaleDateString('en-GB', options);
            const formattedEndDate = endDelivery.toLocaleDateString('en-GB', options);
            document.getElementById('delivery-estimate-text').textContent = `Get delivery by ${formattedStartDate} - ${formattedEndDate}`;
            document.getElementById('conf-track-order-btn').onclick = () => showTrackOrderScreen(orderId);
            document.getElementById('conf-order-history-link').onclick = () => {
                loadMyOrders();
                showScreen('my-orders-screen');
            };
            document.getElementById('conf-continue-shopping-btn').onclick = () => showScreen('home-screen');
            showScreen('order-confirmation-screen');
        }


        // --- My Orders & Order Tracking ---
        function loadMyOrders() {
            if (!currentUser) return;
            const c = document.getElementById('orders-list-container');
            c.innerHTML = '<p class="empty-cart">Loading your orders...</p>';
            const userOrdersQuery = query(ref(db, 'orders'), orderByChild('userId'), equalTo(currentUser.uid));
            get(userOrdersQuery).then(s => {
                if (!s.exists()) {
                    c.innerHTML = `<p class="empty-cart">You haven't placed any orders yet.</p>`;
                    return;
                }
                c.innerHTML = '';
                const orders = [];
                s.forEach(cs => {
                    orders.push({
                        id: cs.key,
                        ...cs.val()
                    });
                });
                orders.reverse().forEach(o => {
                    const el = document.createElement('div');
                    el.className = 'cart-item';
                    const fI = Object.values(o.items)[0];
                    if (fI && fI.imageUrls && fI.imageUrls[0]) {
                        el.innerHTML = `
                            <img src="${fI.imageUrls[0]}">
                            <div class="cart-item-info">
                                <h4>Order from ${new Date(o.orderDate).toLocaleDateString()}</h4>
                                <p>Status: <strong>${o.status}</strong></p>
                                <p>Total: ‚Çπ${o.totalAmount}</p>
                            </div>`;
                        el.onclick = () => showTrackOrderScreen(o.id);
                        c.appendChild(el);
                    }
                });
            }).catch(error => {
                console.error("Firebase Error: Failed to load orders.", error);
                c.innerHTML = `<p class="empty-cart">Couldn't load orders. Please try again. <br><br> <small>Note for developer: This usually happens if the database rules are missing an index on the 'userId' field for the 'orders' collection. Check the browser console for details.</small></p>`;
            });
        }

        function showTrackOrderScreen(orderId) {
            const container = document.getElementById('track-order-content');
            container.innerHTML = '<p class="empty-cart">Loading order details...</p>';
            showScreen('track-order-screen');
            const orderRef = ref(db, `orders/${orderId}`);
            if (activeOrderListener) activeOrderListener();
            activeOrderListener = onValue(orderRef, (snapshot) => {
                if (!snapshot.exists()) {
                    container.innerHTML = '<p class="empty-cart">Order not found.</p>';
                    return;
                }
                const order = snapshot.val();
                const isCancelled = order.status === 'Cancelled';
                const firstItem = Object.values(order.items)[0];
                const orderDate = new Date(order.orderDate);
                const expectedDeliveryDate = new Date();
                expectedDeliveryDate.setDate(orderDate.getDate() + 7)
                const formattedExpectedDate = expectedDeliveryDate.toLocaleDateString('en-GB', {
                    day: 'numeric',
                    month: 'short',
                    year: 'numeric'
                });

                const summaryHTML = `<div class="order-summary-card"><img src="${firstItem.imageUrls[0]}"> <div class="order-summary-info"><h4>${firstItem.title}</h4> <p>Qty: 01</p> <h4>‚Çπ${order.totalAmount}</h4></div></div>`;
                const detailsHTML = `<div class="order-details-section"> <div class="order-detail-row"><span>${isCancelled ? 'Delivery Status' : 'Expected Delivery Date'}</span><span>${isCancelled ? 'Cancelled' : formattedExpectedDate}</span></div> <div class="order-detail-row"><span>Tracking ID</span><span>${orderId.slice(-10).toUpperCase()}</span></div> </div>`;

                const statuses = ['Order Placed', 'In Progress', 'Shipped', 'Delivered'];
                const currentStatusIndex = statuses.indexOf(order.status);

                const icons = ['<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path></svg>', '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path></svg>', '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M9 17a2 2 0 11-4 0 2 2 0 014 0zM19 17a2 2 0 11-4 0 2 2 0 014 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16V6a1 1 0 00-1-1H4a1 1 0 00-1 1v10l2 2h8a1 1 0 001-1zM3 11h6"></path></svg>', '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path></svg>'];
                const checkIconSVG = `<svg fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path></svg>`;

                let timelineHTML = '<ul class="timeline">';

                statuses.forEach((status, index) => {
                    const isActive = isCancelled ? (order.statusHistory && order.statusHistory[status]) : (index <= currentStatusIndex);
                    if (isCancelled && !isActive) return;

                    const statusDate = order.statusHistory && order.statusHistory[status] ? new Date(order.statusHistory[status]).toLocaleString() : '';
                    timelineHTML += `<li class="timeline-item ${isActive ? 'active' : ''}"> <div class="timeline-connector"></div> <div class="timeline-dot">${checkIconSVG}</div> <div class="timeline-content"><h5>${status}</h5> <p>${statusDate}</p></div> <div class="timeline-icon">${icons[index]}</div> </li>`;
                });

                if (isCancelled) {
                    const crossIconSVG = `<svg fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>`;
                    const cancelledIconSVG = `<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636"></path></svg>`;
                    const cancelledDate = order.statusHistory && order.statusHistory['Cancelled'] ? new Date(order.statusHistory['Cancelled']).toLocaleString() : '';
                    timelineHTML += `<li class="timeline-item active cancelled"> <div class="timeline-connector"></div> <div class="timeline-dot">${crossIconSVG}</div> <div class="timeline-content"><h5>Cancelled</h5><p>${cancelledDate}</p></div> <div class="timeline-icon">${cancelledIconSVG}</div> </li>`;
                }

                timelineHTML += '</ul>';
                container.innerHTML = `<div class="track-order-container">${summaryHTML}${detailsHTML}${timelineHTML}</div>`;
            });
        }

        // --- SEARCH & FILTER ---
        function performSearch(searchTerm) {
            const term = searchTerm.toLowerCase().trim();
            if (!term) return;
            const filtered = {};
            for (const id in allProducts) {
                if (allProducts[id].title.toLowerCase().includes(term)) {
                    filtered[id] = allProducts[id];
                }
            }
            document.getElementById('search-query-text').textContent = term;
            document.getElementById('search-bar-results').value = term;
            const resultsCount = Object.keys(filtered).length;
            document.getElementById('search-results-count').textContent = resultsCount;
            activeSortOrder = 'default';
            displayProducts(filtered, 'search-results-grid');
            showScreen('search-results-screen');
        }
        document.getElementById('search-bar').addEventListener('keypress', e => {
            if (e.key === 'Enter') {
                performSearch(e.target.value);
            }
        });
        document.getElementById('search-bar-results').addEventListener('keypress', e => {
            if (e.key === 'Enter') {
                performSearch(e.target.value);
            }
        });

        function filterProductsByCategory(categoryName) {
            const filtered = {};
            for (const id in allProducts) {
                if (allProducts[id].category === categoryName) filtered[id] = allProducts[id];
            }
            activeSortOrder = 'default';
            displayProducts(filtered);
            document.getElementById('product-section-title').textContent = categoryName;
            showScreen('home-screen');
        }

        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded', () => {
            const mobileInput = document.getElementById('delivery-mobile');
            const pincodeInput = document.getElementById('delivery-pincode');
            const filterModal = document.getElementById('filter-modal-overlay');

            mobileInput.addEventListener('input', () => {
                mobileInput.value = mobileInput.value.replace(/[^0-9]/g, '').slice(0, 10);
            });

            pincodeInput.addEventListener('input', () => {
                pincodeInput.value = pincodeInput.value.replace(/[^0-9]/g, '').slice(0, 6);
            });
            pincodeInput.addEventListener('blur', fetchPincodeDetails);

            // --- PAYMENT OPTION SELECTION ---
            document.querySelectorAll('.payment-option').forEach(option => {
                option.addEventListener('click', () => {
                    document.querySelector('.payment-option.selected').classList.remove('selected');
                    option.classList.add('selected');
                });
            });

            // --- DELEGATED EVENT LISTENER FOR FAVORITE CLICKS ---
            document.body.addEventListener('click', (e) => {
                const favIcon = e.target.closest('.fav-icon');
                if (favIcon) {
                    toggleFavorite(favIcon.dataset.productId);
                }
            });

            // --- NEW: REMOVE FROM CART LOGIC ---
            document.getElementById('cart-items-container').addEventListener('click', (e) => {
                const removeBtn = e.target.closest('.remove-from-cart-btn');
                if (removeBtn) {
                    const productId = removeBtn.dataset.productId;
                    if (currentUser && productId) {
                        showDialog({
                            title: "Remove Item",
                            message: "Are you sure you want to remove this item from your cart?",
                            primaryBtnText: "Remove",
                            onPrimaryClick: () => {
                                const itemRef = ref(db, `carts/${currentUser.uid}/${productId}`);
                                set(itemRef, null); // Setting to null removes the data from Firebase
                            },
                            secondaryBtnText: "Cancel"
                        });
                    }
                }
            });

            // --- NEW: Filter Modal Logic ---
            document.querySelectorAll('.filter-icon').forEach(icon => {
                icon.onclick = () => {
                    document.querySelector(`input[name="sort"][value="${activeSortOrder}"]`).checked = true;
                    filterModal.style.display = 'flex';
                };
            });

            document.getElementById('filter-cancel-btn').onclick = () => {
                filterModal.style.display = 'none';
            };

            document.getElementById('filter-apply-btn').onclick = () => {
                activeSortOrder = document.querySelector('input[name="sort"]:checked').value;
                displayProducts(currentlyDisplayedProducts, lastUsedContainerId);
                filterModal.style.display = 'none';
            };

            loadBanners();
            loadCategories();
            loadProducts();
        });
    </script>
</body>

</html>